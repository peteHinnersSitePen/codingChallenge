<div class="container">
  <div class="header">
    <h1>Issues</h1>
    <button class="btn btn-primary" (click)="showCreateModal = true">New Issue</button>
  </div>
  
  <!-- Filters -->
  <div class="filters-card">
    <div class="filter-row">
      <div class="filter-group">
        <label>Search</label>
        <input type="text" [(ngModel)]="filters.searchText" (input)="onFilterChange()" placeholder="Search by title...">
      </div>
      <div class="filter-group">
        <label>Status</label>
        <select [(ngModel)]="filters.status" (change)="onFilterChange()">
          <option [value]="null">All</option>
          <option value="OPEN">Open</option>
          <option value="IN_PROGRESS">In Progress</option>
          <option value="CLOSED">Closed</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Priority</label>
        <select [(ngModel)]="filters.priority" (change)="onFilterChange()">
          <option [value]="null">All</option>
          <option value="LOW">Low</option>
          <option value="MEDIUM">Medium</option>
          <option value="HIGH">High</option>
          <option value="CRITICAL">Critical</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Project</label>
        <select [(ngModel)]="filters.projectId" (change)="onFilterChange()">
          <option value="">All Projects</option>
          <option *ngFor="let project of projects" [value]="project.id">{{ project.name }}</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Sort By</label>
        <select [(ngModel)]="filters.sortBy" (change)="onFilterChange()">
          <option value="createdAt">Created Date</option>
          <option value="updatedAt">Updated Date</option>
          <option value="title">Title</option>
          <option value="priority">Priority</option>
          <option value="status">Status</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Order</label>
        <select [(ngModel)]="filters.sortDir" (change)="onFilterChange()">
          <option value="desc">Descending</option>
          <option value="asc">Ascending</option>
        </select>
      </div>
    </div>
  </div>
  
  <!-- Show loading only on initial load when no data exists -->
  <div *ngIf="loading && !issuesPage" class="loading">Loading issues...</div>
  <div *ngIf="errorMessage" class="error-message">{{ errorMessage }}</div>
  
  <!-- Keep existing data visible while loading to prevent flicker -->
  <div *ngIf="issuesPage && !errorMessage">
    <div *ngIf="issuesPage.content.length === 0" class="empty-state">
      <p *ngIf="hasActiveFilters()">No issues found matching your filters. Try adjusting your search criteria.</p>
      <p *ngIf="!hasActiveFilters() && issuesPage.totalElements === 0">No issues found. Create your first issue!</p>
      <p *ngIf="!hasActiveFilters() && issuesPage.totalElements > 0">No issues found.</p>
    </div>
    
    <div *ngIf="issuesPage.content.length > 0" class="issues-container" [class.loading-opacity]="loading">
      <div *ngFor="let issue of issuesPage.content" class="issue-card" [routerLink]="['/issues', issue.id]">
        <div class="issue-header">
          <h3>{{ issue.title }}</h3>
          <span class="status-badge" [class]="'status-' + issue.status.toLowerCase()">
            {{ formatStatus(issue.status) }}
          </span>
        </div>
        <p class="issue-description">{{ issue.description || 'No description' }}</p>
        <div class="issue-meta">
          <span class="priority-badge" [class]="'priority-' + issue.priority.toLowerCase()">
            {{ issue.priority }}
          </span>
          <span class="project-name">{{ issue.projectName }}</span>
          <span *ngIf="issue.assigneeName" class="assignee">Assigned to: {{ issue.assigneeName }}</span>
          <span class="date">Updated: {{ issue.updatedAt | date:'short' }}</span>
        </div>
      </div>
    </div>
    
    <!-- Pagination -->
    <div *ngIf="issuesPage && issuesPage.totalPages > 1" class="pagination">
      <button class="btn btn-secondary" (click)="previousPage()" [disabled]="filters.page === 0">
        Previous
      </button>
      <span class="page-info">
        Page {{ (filters.page || 0) + 1 }} of {{ issuesPage.totalPages }} 
        ({{ issuesPage.totalElements }} total)
      </span>
      <button class="btn btn-secondary" (click)="nextPage()" [disabled]="issuesPage.last">
        Next
      </button>
    </div>
  </div>
  
  <!-- Create Issue Modal -->
  <div *ngIf="showCreateModal" class="modal-overlay" (click)="closeCreateModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h2>Create New Issue</h2>
      <form (ngSubmit)="onCreateIssue()">
        <div class="form-group">
          <label for="issueTitle">Title *</label>
          <input type="text" id="issueTitle" [(ngModel)]="newIssue.title" name="title" required>
        </div>
        <div class="form-group">
          <label for="issueDescription">Description</label>
          <textarea id="issueDescription" [(ngModel)]="newIssue.description" name="description" rows="4"></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="issueProject">Project *</label>
            <select id="issueProject" [(ngModel)]="newIssue.projectId" name="projectId" required>
              <option [value]="null">Select a project</option>
              <option *ngFor="let project of projects" [value]="project.id">{{ project.name }}</option>
            </select>
          </div>
          <div class="form-group">
            <label for="issuePriority">Priority</label>
            <select id="issuePriority" [(ngModel)]="newIssue.priority" name="priority">
              <option value="LOW">Low</option>
              <option value="MEDIUM" selected>Medium</option>
              <option value="HIGH">High</option>
              <option value="CRITICAL">Critical</option>
            </select>
          </div>
        </div>
        <div *ngIf="createError" class="error-message">{{ createError }}</div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closeCreateModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="creating">
            {{ creating ? 'Creating...' : 'Create' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
